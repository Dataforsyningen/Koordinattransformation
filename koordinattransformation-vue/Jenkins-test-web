pipeline {
   agent none
    stages {
        stage ('Utilhotel') {
            agent { node { label 'Utilhotel' } }
            steps {
                dir('/local/jenkins/koordinattransformation-test/build') {
                    git credentialsId: '48c7f747-c6c3-40aa-9579-b99fc976b0d4',
                    url: 'https://github.com/Dataforsyningen/Koordinattransformation_config',
                    branch: 'develop'
                }
                dir('/local/jenkins/koordinattransformation-test/build/public') {
                    git credentialsId: '48c7f747-c6c3-40aa-9579-b99fc976b0d4',
                    url: 'https://github.com/Dataforsyningen/Koordinattransformation_public',
                    branch: 'develop'
                }
            }
        }

        stage ('build-test') {
            agent { node { label 'Utilhotel' } }
            steps {
                dir('/local/jenkins/koordinattransformation-test/build') {
                    sh 'cp .env* public/koordinattransformation-vue'
                    sh 'docker build --pull -f Dockerfile-test-web --tag dataforsyningen/koordinattransformation-web:test-latest --tag dataforsyningen/koordinattransformation-web:test-$BUILD_NUMBER .'
                    sh 'docker image push dataforsyningen/koordinattransformation-web:test-latest'
                    sh 'docker image push dataforsyningen/koordinattransformation-web:test-$BUILD_NUMBER'
                }
            }
        }

        stage ('deploy-test') {
            agent { node { label 'Webhotel-Prod' } }
            steps {
                dir('/local/jenkins/koordinattransformation-test/deploy') {
                    git credentialsId: '48c7f747-c6c3-40aa-9579-b99fc976b0d4',
                    url: 'https://github.com/Dataforsyningen/Koordinattransformation_config',
                    branch: 'develop'

                    sh 'docker stack rm koordinattransformation_test'
                    sh 'sleep 10'
                    sh 'docker stack deploy -c swarm.test.yml koordinattransformation_test --with-registry-auth --resolve-image always'
                }
            }
        }
    }
}
